# --- Force HTTPS ---
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # --- Redirect www to non-www ---
    RewriteCond %{HTTP_HOST} ^www\.oregon\.tires$ [NC]
    RewriteRule ^(.*)$ https://oregon.tires/$1 [L,R=301]
</IfModule>

# --- Directory Index ---
DirectoryIndex index.html

# --- Error Pages ---
ErrorDocument 404 /404.html
ErrorDocument 403 /index.html

# --- Block access to dotfiles (except this .htaccess) ---
<FilesMatch "^\.ht">
    Require all denied
</FilesMatch>

# --- Prevent directory listing ---
Options -Indexes

# --- Security Headers ---
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://*.google-analytics.com https://*.googletagmanager.com; connect-src 'self' https://*.google-analytics.com https://*.analytics.google.com https://*.googletagmanager.com; frame-src https://www.google.com; font-src 'self';"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains" env=HTTPS
</IfModule>

# --- Enable GZIP compression ---
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/css application/javascript image/svg+xml
</IfModule>

# --- Cache static assets ---
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
</IfModule>

# --- Block access to sensitive files ---
<FilesMatch "(\.sql|\.env|\.git|package\.json|\.bak|\.tmp)$">
    Require all denied
</FilesMatch>

# --- Block CLI scripts and admin-only PHP from web access ---
<FilesMatch "^(send-setup-emails\.php)$">
    Require all denied
</FilesMatch>

# --- Block /cli/ directory ---
<IfModule mod_rewrite.c>
    RewriteRule ^cli/ - [F,L]
</IfModule>
