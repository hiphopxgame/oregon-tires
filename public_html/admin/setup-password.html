<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Configurar Contrasena — Oregon Tires Admin</title>
  <link rel="icon" href="assets/favicon.ico" sizes="any">
  <link rel="icon" href="assets/favicon.png" type="image/png" sizes="32x32">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
  <link rel="stylesheet" href="assets/styles.css">
  <style>
    .brand-gradient { background: linear-gradient(135deg, #15803d 0%, #166534 50%, #1a1a2e 100%); }
    .input-focus:focus { box-shadow: 0 0 0 3px rgba(21, 128, 61, 0.3); }
  </style>
</head>
<body class="min-h-screen brand-gradient flex items-center justify-center p-4">
  <div class="w-full max-w-md">
    <!-- Logo -->
    <div class="text-center mb-8">
      <a href="/"><img src="assets/logo.png" alt="Oregon Tires Auto Care" class="h-20 mx-auto mb-4 drop-shadow-lg"></a>
      <h1 class="text-2xl font-bold text-white">Panel de Administracion</h1>
      <p class="text-green-200 mt-1">Admin Panel</p>
    </div>

    <!-- Card -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl overflow-hidden">
      <!-- Header -->
      <div class="bg-gray-50 dark:bg-gray-700 px-8 py-6 border-b border-gray-200 dark:border-gray-600">
        <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100" id="card-title">Configurar Contrasena</h2>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" id="card-subtitle">Set Up Your Password</p>
      </div>

      <!-- Loading state -->
      <div id="loading-state" class="px-8 py-12 text-center">
        <div class="animate-spin w-8 h-8 border-4 border-green-500 border-t-transparent rounded-full mx-auto"></div>
        <p class="mt-4 text-gray-500 dark:text-gray-400">Validando enlace... / Validating link...</p>
      </div>

      <!-- Form (hidden initially) -->
      <form id="setup-form" class="px-8 py-6 hidden" onsubmit="return handleSubmit(event)">
        <div id="welcome-msg" class="mb-6 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
          <p class="text-green-800 dark:text-green-300 font-medium">Bienvenido/a, <span id="admin-name" class="font-bold"></span></p>
          <p class="text-green-600 dark:text-green-400 text-sm mt-1">Welcome! Please create a secure password for your admin account.</p>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1">
              Nueva Contrasena <span class="font-normal text-gray-400 dark:text-gray-500">/ New Password</span>
            </label>
            <input type="password" id="password" required minlength="8" maxlength="72"
              class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg input-focus focus:border-green-500 outline-none transition bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100"
              placeholder="Minimo 8 caracteres">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1">
              Confirmar Contrasena <span class="font-normal text-gray-400 dark:text-gray-500">/ Confirm Password</span>
            </label>
            <input type="password" id="confirm-password" required minlength="8" maxlength="72"
              class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg input-focus focus:border-green-500 outline-none transition bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100"
              placeholder="Repetir contrasena">
          </div>

          <!-- Password requirements -->
          <div class="text-xs text-gray-500 dark:text-gray-400 space-y-1">
            <p class="font-semibold text-gray-600 dark:text-gray-300">Requisitos / Requirements:</p>
            <p id="req-length" class="flex items-center gap-1"><span class="text-gray-400 dark:text-gray-500">&#9675;</span> Minimo 8 caracteres / At least 8 characters</p>
            <p id="req-upper" class="flex items-center gap-1"><span class="text-gray-400 dark:text-gray-500">&#9675;</span> Una mayuscula / One uppercase letter</p>
            <p id="req-lower" class="flex items-center gap-1"><span class="text-gray-400 dark:text-gray-500">&#9675;</span> Una minuscula / One lowercase letter</p>
            <p id="req-number" class="flex items-center gap-1"><span class="text-gray-400 dark:text-gray-500">&#9675;</span> Un numero / One number</p>
          </div>
        </div>

        <div id="form-error" class="hidden mt-4 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-700 dark:text-red-400 text-sm"></div>

        <button type="submit" id="submit-btn"
          class="w-full mt-6 py-3 bg-green-700 hover:bg-green-800 text-white font-bold rounded-lg transition-colors shadow-md">
          Guardar Contrasena / Save Password
        </button>
      </form>

      <!-- Success state (hidden) -->
      <div id="success-state" class="px-8 py-12 text-center hidden">
        <div class="w-16 h-16 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">Contrasena Configurada</h3>
        <p class="text-gray-500 dark:text-gray-400 mt-2">Password Set Successfully</p>
        <a href="/admin/" class="inline-block mt-6 px-8 py-3 bg-green-700 hover:bg-green-800 text-white font-bold rounded-lg transition-colors shadow-md">
          Ir al Panel / Go to Admin Panel
        </a>
      </div>

      <!-- Error state (hidden) -->
      <div id="error-state" class="px-8 py-12 text-center hidden">
        <div class="w-16 h-16 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">Enlace Invalido o Expirado</h3>
        <p class="text-gray-500 dark:text-gray-400 mt-2">Invalid or Expired Link</p>
        <p class="text-sm text-gray-400 dark:text-gray-500 mt-4">Contacte al administrador para obtener un nuevo enlace.<br>Contact admin for a new setup link.</p>
        <div class="mt-6 space-y-2">
          <a href="/admin/" class="inline-block px-6 py-2 bg-green-700 hover:bg-green-800 text-white font-medium rounded-lg transition-colors text-sm">Ir al Login / Go to Login</a>
          <br>
          <a href="/" class="text-green-600 dark:text-green-400 text-sm hover:underline">← Volver al sitio / Back to website</a>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="text-center mt-6 space-y-2">
      <p class="text-green-200/60 text-xs">&copy; 2026 Oregon Tires Auto Care</p>
      <div class="flex justify-center gap-4">
        <a href="/" class="text-green-200/80 text-xs hover:text-white transition-colors">Home</a>
        <a href="/admin/" class="text-green-200/80 text-xs hover:text-white transition-colors">Admin Login</a>
        <a href="/book-appointment/" class="text-green-200/80 text-xs hover:text-white transition-colors">Book Appointment</a>
      </div>
    </div>
  </div>

<script>
var API_BASE = '/api';
var currentToken = '';
var userLang = 'es';

var setupText = {
  es: {
    title: 'Configurar Contrasena',
    subtitle: 'Set Up Your Password',
    successTitle: 'Contrasena Configurada',
    successSub: 'Password Set Successfully',
    goToPanel: 'Ir al Panel / Go to Admin Panel',
    errorTitle: 'Enlace Invalido o Expirado',
    errorSub: 'Invalid or Expired Link',
    errorHelp: 'Contacte al administrador para obtener un nuevo enlace.',
    errorHelpAlt: 'Contact admin for a new setup link.'
  },
  en: {
    title: 'Set Up Your Password',
    subtitle: 'Configurar Contrasena',
    successTitle: 'Password Set Successfully',
    successSub: 'Contrasena Configurada',
    goToPanel: 'Go to Admin Panel / Ir al Panel',
    errorTitle: 'Invalid or Expired Link',
    errorSub: 'Enlace Invalido o Expirado',
    errorHelp: 'Contact admin for a new setup link.',
    errorHelpAlt: 'Contacte al administrador para obtener un nuevo enlace.'
  }
};

function applyLanguage() {
  var t = setupText[userLang] || setupText.es;
  document.documentElement.lang = userLang;
  document.getElementById('card-title').textContent = t.title;
  document.getElementById('card-subtitle').textContent = t.subtitle;
  document.querySelector('#success-state h3').textContent = t.successTitle;
  document.querySelector('#success-state p.text-gray-500, #success-state p.dark\\:text-gray-400').textContent = t.successSub;
  document.querySelector('#success-state a').textContent = t.goToPanel;
  document.querySelector('#error-state h3').textContent = t.errorTitle;
  var errorSubEl = document.querySelectorAll('#error-state p')[0];
  if (errorSubEl) errorSubEl.textContent = t.errorSub;
  var helpEl = document.querySelector('#error-state p.text-sm');
  if (helpEl) {
    helpEl.textContent = '';
    helpEl.appendChild(document.createTextNode(t.errorHelp));
    helpEl.appendChild(document.createElement('br'));
    helpEl.appendChild(document.createTextNode(t.errorHelpAlt));
  }
}

var params = new URLSearchParams(window.location.search);
currentToken = params.get('token') || '';

(async function() {
  if (!currentToken || !/^[a-f0-9]{64}$/.test(currentToken)) {
    showError();
    return;
  }

  document.getElementById('loading-state').classList.add('hidden');
  document.getElementById('setup-form').classList.remove('hidden');

  try {
    var res = await fetch(API_BASE + '/admin/verify-token.php?token=' + encodeURIComponent(currentToken), { credentials: 'include' });
    var json = await res.json();
    if (json.success && json.data && json.data.name) {
      document.getElementById('admin-name').textContent = json.data.name;
      if (json.data.language === 'en') {
        userLang = 'en';
      } else {
        userLang = 'es';
      }
      applyLanguage();
    } else {
      showError();
    }
  } catch (e) {
    document.getElementById('admin-name').textContent = '';
    document.getElementById('welcome-msg').classList.add('hidden');
  }
})();

var pw = document.getElementById('password');
pw.addEventListener('input', function() {
  var v = pw.value;
  setReq('req-length', v.length >= 8);
  setReq('req-upper', /[A-Z]/.test(v));
  setReq('req-lower', /[a-z]/.test(v));
  setReq('req-number', /[0-9]/.test(v));
});

function setReq(id, met) {
  var el = document.getElementById(id);
  var span = el.querySelector('span');
  if (met) {
    span.textContent = '\u2713';
    span.classList.remove('text-gray-400', 'dark:text-gray-500');
    span.classList.add('text-green-600', 'dark:text-green-400');
    el.classList.remove('text-gray-500');
    el.classList.add('text-green-700', 'dark:text-green-400');
  } else {
    span.textContent = '\u25CB';
    span.classList.remove('text-green-600', 'dark:text-green-400');
    span.classList.add('text-gray-400', 'dark:text-gray-500');
    el.classList.remove('text-green-700', 'dark:text-green-400');
    el.classList.add('text-gray-500');
  }
}

async function handleSubmit(e) {
  e.preventDefault();
  var password = document.getElementById('password').value;
  var confirm = document.getElementById('confirm-password').value;
  var errEl = document.getElementById('form-error');
  var btn = document.getElementById('submit-btn');

  errEl.classList.add('hidden');

  if (password !== confirm) {
    errEl.textContent = 'Las contrasenas no coinciden. / Passwords do not match.';
    errEl.classList.remove('hidden');
    return false;
  }

  btn.disabled = true;
  btn.textContent = 'Guardando... / Saving...';

  try {
    var res = await fetch(API_BASE + '/admin/setup-password.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ token: currentToken, password: password })
    });
    var json = await res.json();

    if (!res.ok || !json.success) {
      throw new Error(json.error || 'Failed');
    }

    document.getElementById('setup-form').classList.add('hidden');
    document.getElementById('success-state').classList.remove('hidden');

  } catch (err) {
    errEl.textContent = err.message || 'Error al configurar contrasena. / Error setting password.';
    errEl.classList.remove('hidden');
    btn.disabled = false;
    btn.textContent = 'Guardar Contrasena / Save Password';
  }

  return false;
}

function showError() {
  document.getElementById('loading-state').classList.add('hidden');
  document.getElementById('error-state').classList.remove('hidden');
}
</script>
</body>
</html>
