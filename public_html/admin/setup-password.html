<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Configurar Contraseña — Oregon Tires Admin</title>
  <link rel="icon" href="/assets/favicon.png" type="image/png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .brand-gradient { background: linear-gradient(135deg, #15803d 0%, #166534 50%, #1a1a2e 100%); }
    .input-focus:focus { box-shadow: 0 0 0 3px rgba(21, 128, 61, 0.3); }
  </style>
</head>
<body class="min-h-screen brand-gradient flex items-center justify-center p-4">
  <div class="w-full max-w-md">
    <!-- Logo -->
    <div class="text-center mb-8">
      <img src="/assets/logo.png" alt="Oregon Tires Auto Care" class="h-20 mx-auto mb-4 drop-shadow-lg">
      <h1 class="text-2xl font-bold text-white">Panel de Administración</h1>
      <p class="text-green-200 mt-1">Admin Panel</p>
    </div>

    <!-- Card -->
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
      <!-- Header -->
      <div class="bg-gray-50 px-8 py-6 border-b">
        <h2 class="text-xl font-bold text-gray-800" id="card-title">Configurar Contraseña</h2>
        <p class="text-sm text-gray-500 mt-1" id="card-subtitle">Set Up Your Password</p>
        <p class="text-xs text-gray-400 mt-2" id="card-lang-hint"></p>
      </div>

      <!-- Loading state -->
      <div id="loading-state" class="px-8 py-12 text-center">
        <div class="animate-spin w-8 h-8 border-4 border-green-500 border-t-transparent rounded-full mx-auto"></div>
        <p class="mt-4 text-gray-500">Validando enlace... / Validating link...</p>
      </div>

      <!-- Form (hidden initially) -->
      <form id="setup-form" class="px-8 py-6 hidden" onsubmit="return handleSubmit(event)">
        <div id="welcome-msg" class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
          <p class="text-green-800 font-medium">Bienvenido/a, <span id="admin-name" class="font-bold"></span></p>
          <p class="text-green-600 text-sm mt-1">Welcome! Please create a secure password for your admin account.</p>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">
              Nueva Contraseña <span class="font-normal text-gray-400">/ New Password</span>
            </label>
            <input type="password" id="password" required minlength="8" maxlength="72"
              class="w-full p-3 border border-gray-300 rounded-lg input-focus focus:border-green-500 outline-none transition"
              placeholder="Mínimo 8 caracteres">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">
              Confirmar Contraseña <span class="font-normal text-gray-400">/ Confirm Password</span>
            </label>
            <input type="password" id="confirm-password" required minlength="8" maxlength="72"
              class="w-full p-3 border border-gray-300 rounded-lg input-focus focus:border-green-500 outline-none transition"
              placeholder="Repetir contraseña">
          </div>

          <!-- Password requirements -->
          <div class="text-xs text-gray-500 space-y-1">
            <p class="font-semibold text-gray-600">Requisitos / Requirements:</p>
            <p id="req-length" class="flex items-center gap-1"><span class="text-gray-300">○</span> Mínimo 8 caracteres / At least 8 characters</p>
            <p id="req-upper" class="flex items-center gap-1"><span class="text-gray-300">○</span> Una mayúscula / One uppercase letter</p>
            <p id="req-lower" class="flex items-center gap-1"><span class="text-gray-300">○</span> Una minúscula / One lowercase letter</p>
            <p id="req-number" class="flex items-center gap-1"><span class="text-gray-300">○</span> Un número / One number</p>
          </div>
        </div>

        <div id="form-error" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"></div>

        <button type="submit" id="submit-btn"
          class="w-full mt-6 py-3 bg-green-700 hover:bg-green-800 text-white font-bold rounded-lg transition-colors shadow-md">
          Guardar Contraseña / Save Password
        </button>
      </form>

      <!-- Success state (hidden) -->
      <div id="success-state" class="px-8 py-12 text-center hidden">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-800">Contraseña Configurada</h3>
        <p class="text-gray-500 mt-2">Password Set Successfully</p>
        <a href="/admin/" class="inline-block mt-6 px-8 py-3 bg-green-700 hover:bg-green-800 text-white font-bold rounded-lg transition-colors shadow-md">
          Ir al Panel / Go to Admin Panel
        </a>
      </div>

      <!-- Error state (hidden) -->
      <div id="error-state" class="px-8 py-12 text-center hidden">
        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-800">Enlace Inválido o Expirado</h3>
        <p class="text-gray-500 mt-2">Invalid or Expired Link</p>
        <p class="text-sm text-gray-400 mt-4">Contacte al administrador para obtener un nuevo enlace.<br>Contact admin for a new setup link.</p>
      </div>
    </div>

    <!-- Footer -->
    <p class="text-center text-green-200/60 text-xs mt-6">&copy; 2026 Oregon Tires Auto Care</p>
  </div>

<script>
const API_BASE = '/api';
let currentToken = '';
let userLang = 'es'; // default to Spanish

// Bilingual text map — primary shown as main, secondary shown smaller
const setupText = {
  es: {
    title: 'Configurar Contraseña',
    subtitle: 'Set Up Your Password',
    successTitle: 'Contraseña Configurada',
    successSub: 'Password Set Successfully',
    goToPanel: 'Ir al Panel / Go to Admin Panel',
    errorTitle: 'Enlace Inválido o Expirado',
    errorSub: 'Invalid or Expired Link',
    errorHelp: 'Contacte al administrador para obtener un nuevo enlace.',
    errorHelpAlt: 'Contact admin for a new setup link.'
  },
  en: {
    title: 'Set Up Your Password',
    subtitle: 'Configurar Contraseña',
    successTitle: 'Password Set Successfully',
    successSub: 'Contraseña Configurada',
    goToPanel: 'Go to Admin Panel / Ir al Panel',
    errorTitle: 'Invalid or Expired Link',
    errorSub: 'Enlace Inválido o Expirado',
    errorHelp: 'Contact admin for a new setup link.',
    errorHelpAlt: 'Contacte al administrador para obtener un nuevo enlace.'
  }
};

function applyLanguage() {
  var t = setupText[userLang] || setupText.es;
  document.documentElement.lang = userLang;
  document.getElementById('card-title').textContent = t.title;
  document.getElementById('card-subtitle').textContent = t.subtitle;
  // Success/error states
  document.querySelector('#success-state h3').textContent = t.successTitle;
  document.querySelector('#success-state p.text-gray-500').textContent = t.successSub;
  document.querySelector('#success-state a').textContent = t.goToPanel;
  document.querySelector('#error-state h3').textContent = t.errorTitle;
  document.querySelector('#error-state p.text-gray-500').textContent = t.errorSub;
  // Error help text — two lines using safe DOM methods
  var helpEl = document.querySelector('#error-state p.text-sm');
  helpEl.textContent = '';
  helpEl.appendChild(document.createTextNode(t.errorHelp));
  helpEl.appendChild(document.createElement('br'));
  helpEl.appendChild(document.createTextNode(t.errorHelpAlt));
}

// Get token from URL
const params = new URLSearchParams(window.location.search);
currentToken = params.get('token') || '';

// Validate token on load
(async function() {
  if (!currentToken || !/^[a-f0-9]{64}$/.test(currentToken)) {
    showError();
    return;
  }

  document.getElementById('loading-state').classList.add('hidden');
  document.getElementById('setup-form').classList.remove('hidden');

  try {
    var res = await fetch(API_BASE + '/admin/verify-token.php?token=' + encodeURIComponent(currentToken), { credentials: 'include' });
    var json = await res.json();
    if (json.success && json.data && json.data.name) {
      document.getElementById('admin-name').textContent = json.data.name;
      // Apply language preference from the user's account
      if (json.data.language === 'en') {
        userLang = 'en';
      } else {
        userLang = 'es'; // 'es' or 'both' defaults to Spanish primary
      }
      applyLanguage();
    } else {
      showError();
    }
  } catch (e) {
    document.getElementById('admin-name').textContent = '';
    document.getElementById('welcome-msg').classList.add('hidden');
  }
})();

// Live password validation
var pw = document.getElementById('password');
pw.addEventListener('input', function() {
  var v = pw.value;
  setReq('req-length', v.length >= 8);
  setReq('req-upper', /[A-Z]/.test(v));
  setReq('req-lower', /[a-z]/.test(v));
  setReq('req-number', /[0-9]/.test(v));
});

function setReq(id, met) {
  var el = document.getElementById(id);
  var span = el.querySelector('span');
  if (met) {
    span.textContent = '\u2713';
    span.className = 'text-green-600';
    el.className = el.className.replace('text-gray-500', '').trim() + ' text-green-700';
  } else {
    span.textContent = '\u25CB';
    span.className = 'text-gray-300';
    el.className = el.className.replace('text-green-700', '').trim();
    if (!el.className.includes('text-gray-500')) el.className += ' text-gray-500';
  }
}

async function handleSubmit(e) {
  e.preventDefault();
  var password = document.getElementById('password').value;
  var confirm = document.getElementById('confirm-password').value;
  var errEl = document.getElementById('form-error');
  var btn = document.getElementById('submit-btn');

  errEl.classList.add('hidden');

  if (password !== confirm) {
    errEl.textContent = 'Las contraseñas no coinciden. / Passwords do not match.';
    errEl.classList.remove('hidden');
    return false;
  }

  btn.disabled = true;
  btn.textContent = 'Guardando... / Saving...';

  try {
    var res = await fetch(API_BASE + '/admin/setup-password.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ token: currentToken, password: password })
    });
    var json = await res.json();

    if (!res.ok || !json.success) {
      throw new Error(json.error || 'Failed');
    }

    document.getElementById('setup-form').classList.add('hidden');
    document.getElementById('success-state').classList.remove('hidden');

  } catch (err) {
    errEl.textContent = err.message || 'Error al configurar contraseña. / Error setting password.';
    errEl.classList.remove('hidden');
    btn.disabled = false;
    btn.textContent = 'Guardar Contraseña / Save Password';
  }

  return false;
}

function showError() {
  document.getElementById('loading-state').classList.add('hidden');
  document.getElementById('error-state').classList.remove('hidden');
}
</script>
</body>
</html>
